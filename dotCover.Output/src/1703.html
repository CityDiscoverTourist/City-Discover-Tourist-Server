<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\C#\CityDiscoverTourist\CityDiscoverTourist.Business\Helper\EmailHelper\MailSender.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Diagnostics;
using System.Globalization;
using Microsoft.AspNetCore.Mvc;
using MimeKit;
using MimeKit.Text;
using TutorHelper_v2.Business.Helper.EmailHelper;
using SmtpClient = MailKit.Net.Smtp.SmtpClient;

namespace CityDiscoverTourist.Business.Helper.EmailHelper;

public class EmailSender : IEmailSender
{
    private readonly EmailConfiguration _emailConfig;
    private static string errorInfo, Errormsg, ErrorLocation, extype, exurl = null, Frommail, ToMail, Sub, HostAdd, EmailHead, EmailSing;

    public EmailSender(EmailConfiguration emailConfig)
    {
        _emailConfig = emailConfig;
    }

    public void SendEmail(Message message)
    {
        var emailMessage = CreateEmailMessage(message);

        Send(emailMessage);
    }

    public async Task SendEmailAsync(Message message)
    {
        var mailMessage = CreateEmailMessage(message);

        await SendAsync(mailMessage);
    }

    public void SendMailWithMailGun(Message message)
    {
        var mailMessage = new MimeMessage();
        mailMessage.From.Add(new MailboxAddress(&quot;Admin&quot;,
            &quot;postmaster@sandbox583bda9281f2472f83cbcfa4ddccf205.mailgun.org&quot;));
        mailMessage.To.Add(new MailboxAddress(&quot;User&quot;, &quot;dathaha2000@gmail.com&quot;));
        mailMessage.Subject = message.Subject;
        mailMessage.Body = new TextPart(&quot;plain&quot;)
        {
            Text = message.Content
        };

        using (var client = new SmtpClient())
        {
            client.ServerCertificateValidationCallback = (s, c, h, e) =&gt; true;

            client.Connect (&quot;smtp.mailgun.org&quot;, 587, false);
            client.AuthenticationMechanisms.Remove (&quot;XOAUTH2&quot;);
            client.Authenticate (&quot;postmaster@sandbox583bda9281f2472f83cbcfa4ddccf205.mailgun.org&quot;,
                &quot;ff91ac5a481f75f1a76bc3c93d3adce8-cac494aa-4707a7e9&quot;);

            client.Send (mailMessage);
            client.Disconnect (true);
        }
    }

    public void SendMailException(System.Exception ex)
    {
       try
       {
           const string newline = &quot;&lt;br/&gt;&quot;;
           Debug.Assert(ex.StackTrace != null, &quot;ex.StackTrace != null&quot;);
           errorInfo = ex.StackTrace;
           Errormsg = ex.GetType().Name;
           extype = ex.GetType().ToString();

           ErrorLocation = ex.Message;
           EmailHead = &quot;&lt;b&gt;Dear Team,&lt;/b&gt;&quot; + &quot;&lt;br/&gt;&quot; + &quot;An exception occurred in a Application Url&quot; + &quot; &quot; + exurl + &quot; &quot; + &quot;With following Details&quot; + &quot;&lt;br/&gt;&quot; + &quot;&lt;br/&gt;&quot;;
           EmailSing = newline + &quot;Thanks and Regards&quot; + newline + &quot;    &quot; + &quot;     &quot; + &quot;&lt;b&gt;Application Admin &lt;/b&gt;&quot; + &quot;&lt;/br&gt;&quot;;
           Sub = &quot;Exception occurred&quot; + &quot; &quot; + &quot;in Application&quot; + &quot; &quot; + exurl;
           var errorContext = EmailHead + &quot;&lt;b&gt;Log Written Date: &lt;/b&gt;&quot; + &quot; &quot; + DateTime.Now.ToString(CultureInfo.InvariantCulture) + newline +
                              &quot;&lt;b&gt;Error Line No :&lt;/b&gt;&quot; + &quot; &quot; + errorInfo + &quot;\t\n&quot; + &quot; &quot; + newline +
                              &quot;&lt;b&gt;Error Message:&lt;/b&gt;&quot; + &quot; &quot; + Errormsg + newline +
                              &quot;&lt;b&gt;Exception Type:&lt;/b&gt;&quot; + &quot; &quot; + extype + newline +
                              &quot;&lt;b&gt;Error Details :&lt;/b&gt;&quot; + &quot; &quot; + ErrorLocation + newline +
                              &quot;&lt;b&gt;Error Page Url:&lt;/b&gt;&quot; + &quot; &quot; + exurl + newline + newline + newline + newline + EmailSing;
           using (var mailMessage = new MimeMessage())
           {
               mailMessage.From.Add(new MailboxAddress(&quot;Admin&quot;,
                   _emailConfig.From));
               mailMessage.To.Add(new MailboxAddress(&quot;User&quot;, _emailConfig.AdminEmail));
               mailMessage.Subject = Sub;
               mailMessage.Body = new TextPart(TextFormat.Html)
               {
                   Text = errorContext
               };
               using (var client = new SmtpClient())
               {
                   client.ServerCertificateValidationCallback = (s, c, h, e) =&gt; true;

                   client.Connect (_emailConfig.SmtpServer, _emailConfig.Port, false);
                   client.AuthenticationMechanisms.Remove (&quot;XOAUTH2&quot;);
                   client.Authenticate (_emailConfig.UserName, _emailConfig.Password);

                   client.Send (mailMessage);
                   client.Disconnect (true);
               }
           }
       }
       catch (System.Exception em)
       {
           em.ToString();
       }
    }

    public void SendMailException(ProblemDetails pd)
    {
        try
        {
           const string newline = &quot;&lt;br/&gt;&quot;;
           errorInfo = (string) pd.Extensions[&quot;trace&quot;];
           Errormsg = pd.Title;
           extype = pd.Type;

           ErrorLocation = pd.Detail;
           EmailHead = &quot;&lt;b&gt;Dear Team,&lt;/b&gt;&quot; + &quot;&lt;br/&gt;&quot; + &quot;An exception occurred in a Application Url&quot; + &quot; &quot; + exurl + &quot; &quot; + &quot;With following Details&quot; + &quot;&lt;br/&gt;&quot; + &quot;&lt;br/&gt;&quot;;
           EmailSing = newline + &quot;Thanks and Regards&quot; + newline + &quot;    &quot; + &quot;     &quot; + &quot;&lt;b&gt;Application Admin &lt;/b&gt;&quot; + &quot;&lt;/br&gt;&quot;;
           Sub = &quot;Exception occurred&quot; + &quot; &quot; + &quot;in Application&quot; + &quot; &quot; + exurl;
           var errorContext = EmailHead + &quot;&lt;b&gt;Log Written Date: &lt;/b&gt;&quot; + &quot; &quot; + DateTime.Now.ToString(CultureInfo.InvariantCulture) + newline +
                              &quot;&lt;b&gt;Error Line No :&lt;/b&gt;&quot; + &quot; &quot; + errorInfo + &quot;\t\n&quot; + &quot; &quot; + newline +
                              &quot;&lt;b&gt;Error Message:&lt;/b&gt;&quot; + &quot; &quot; + Errormsg + newline +
                              &quot;&lt;b&gt;Exception Type:&lt;/b&gt;&quot; + &quot; &quot; + extype + newline +
                              &quot;&lt;b&gt;Error Details :&lt;/b&gt;&quot; + &quot; &quot; + ErrorLocation + newline +
                              &quot;&lt;b&gt;Error Page Url:&lt;/b&gt;&quot; + &quot; &quot; + exurl + newline + newline + newline + newline + EmailSing;
           using (var mailMessage = new MimeMessage())
           {
               mailMessage.From.Add(new MailboxAddress(&quot;Admin&quot;,
                   _emailConfig.From));
               mailMessage.To.Add(new MailboxAddress(&quot;User&quot;, _emailConfig.AdminEmail));
               mailMessage.Subject = Sub;
               mailMessage.Body = new TextPart(TextFormat.Html)
               {
                   Text = errorContext
               };
               using (var client = new SmtpClient())
               {
                   client.ServerCertificateValidationCallback = (s, c, h, e) =&gt; true;

                   client.Connect (_emailConfig.SmtpServer, _emailConfig.Port, false);
                   client.AuthenticationMechanisms.Remove (&quot;XOAUTH2&quot;);
                   client.Authenticate (_emailConfig.UserName, _emailConfig.Password);

                   client.Send (mailMessage);
                   client.Disconnect (true);
               }
           }
       }
       catch (System.Exception em)
       {
           em.ToString();
       }
    }

    private MimeMessage CreateEmailMessage(Message message)
    {
        var emailMessage = new MimeMessage();
        emailMessage.From.Add(new MailboxAddress(&quot;&quot;, _emailConfig.From));
        emailMessage.To.AddRange(message.To);
        emailMessage.Subject = message.Subject;

        var bodyBuilder = new BodyBuilder
            { HtmlBody = string.Format(&quot;&lt;h2 style=&#39;color:red;&#39;&gt;{0}&lt;/h2&gt;&quot;, message.Content) };

        if (message.Attachments.Any())
        {
            byte[] fileBytes;
            foreach (var attachment in message.Attachments)
            {
                using (var ms = new MemoryStream())
                {
                    attachment.CopyTo(ms);
                    fileBytes = ms.ToArray();
                }

                bodyBuilder.Attachments.Add(attachment.FileName, fileBytes, ContentType.Parse(attachment.ContentType));
            }
        }

        emailMessage.Body = bodyBuilder.ToMessageBody();
        return emailMessage;
    }

    private void Send(MimeMessage mailMessage)
    {
        using (var client = new SmtpClient())
        {
            try
            {
                client.Connect(_emailConfig.SmtpServer, _emailConfig.Port, true);
                client.AuthenticationMechanisms.Remove(&quot;XOAUTH2&quot;);
                client.Authenticate(_emailConfig.UserName, _emailConfig.Password);

                client.Send(mailMessage);
            }
            finally
            {
                client.Disconnect(true);
                client.Dispose();
            }
        }
    }

    private async Task SendAsync(MimeMessage mailMessage)
    {
        using (var client = new SmtpClient())
        {
            try
            {
                await client.ConnectAsync(_emailConfig.SmtpServer, _emailConfig.Port, true);
                client.AuthenticationMechanisms.Remove(&quot;XOAUTH2&quot;);
                await client.AuthenticateAsync(_emailConfig.UserName, _emailConfig.Password);

                await client.SendAsync(mailMessage);
            }
            finally
            {
                await client.DisconnectAsync(true);
                client.Dispose();
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,5,16,55,0],[17,5,17,6,0],[18,9,18,36,0],[19,5,19,6,0],[22,5,22,6,0],[23,9,23,56,0],[25,9,25,28,0],[26,5,26,6,0],[29,5,29,6,0],[30,9,30,55,0],[32,9,32,38,0],[33,5,33,6,0],[36,5,36,6,0],[37,9,37,45,0],[38,9,39,80,0],[40,9,40,81,0],[41,9,41,47,0],[42,9,45,11,0],[47,16,47,45,0],[48,9,48,10,0],[49,13,49,74,0],[49,74,49,78,0],[49,78,49,79,0],[51,13,51,61,0],[52,13,52,64,0],[53,13,54,71,0],[56,13,56,39,0],[57,13,57,38,0],[58,9,58,10,0],[59,5,59,6,0],[62,5,62,6,0],[64,8,64,9,0],[66,12,66,73,0],[67,12,67,38,0],[68,12,68,41,0],[69,12,69,45,0],[71,12,71,39,0],[72,12,72,168,0],[73,12,73,124,0],[74,12,74,78,0],[75,12,80,122,0],[81,19,81,54,0],[82,12,82,13,0],[83,16,84,40,0],[85,16,85,88,0],[86,16,86,42,0],[87,16,90,18,0],[91,23,91,52,0],[92,16,92,17,0],[93,20,93,81,0],[93,81,93,85,0],[93,85,93,86,0],[95,20,95,87,0],[96,20,96,71,0],[97,20,97,87,0],[99,20,99,46,0],[100,20,100,45,0],[101,16,101,17,0],[102,12,102,13,0],[103,8,103,9,0],[104,8,104,35,0],[105,8,105,9,0],[106,12,106,26,0],[107,8,107,9,0],[108,5,108,6,0],[111,5,111,6,0],[113,9,113,10,0],[115,12,115,56,0],[116,12,116,32,0],[117,12,117,29,0],[119,12,119,38,0],[120,12,120,168,0],[121,12,121,124,0],[122,12,122,78,0],[123,12,128,122,0],[129,19,129,54,0],[130,12,130,13,0],[131,16,132,40,0],[133,16,133,88,0],[134,16,134,42,0],[135,16,138,18,0],[139,23,139,52,0],[140,16,140,17,0],[141,20,141,81,0],[141,81,141,85,0],[141,85,141,86,0],[143,20,143,87,0],[144,20,144,71,0],[145,20,145,87,0],[147,20,147,46,0],[148,20,148,45,0],[149,16,149,17,0],[150,12,150,13,0],[151,8,151,9,0],[152,8,152,35,0],[153,8,153,9,0],[154,12,154,26,0],[155,8,155,9,0],[156,5,156,6,0],[159,5,159,6,0],[160,9,160,46,0],[161,9,161,74,0],[162,9,162,46,0],[163,9,163,48,0],[165,9,166,94,0],[168,9,168,39,0],[169,9,169,10,0],[171,13,171,20,0],[171,22,171,36,0],[171,37,171,39,0],[171,40,171,59,0],[172,13,172,14,0],[173,24,173,51,0],[174,17,174,18,0],[175,21,175,43,0],[176,21,176,46,0],[177,17,177,18,0],[179,17,179,120,0],[180,13,180,14,0],[181,9,181,10,0],[183,9,183,57,0],[184,9,184,29,0],[185,5,185,6,0],[188,5,188,6,0],[189,16,189,45,0],[190,9,190,10,0],[192,13,192,14,0],[193,17,193,82,0],[194,17,194,67,0],[195,17,195,83,0],[197,17,197,42,0],[198,13,198,14,0],[200,13,200,14,0],[201,17,201,41,0],[202,17,202,34,0],[203,13,203,14,0],[204,9,204,10,0],[205,5,205,6,0],[208,5,208,6,0],[209,16,209,45,0],[210,9,210,10,0],[212,13,212,14,0],[213,17,213,93,0],[214,17,214,67,0],[215,17,215,94,0],[217,17,217,53,0],[218,13,218,14,0],[220,13,220,14,0],[221,17,221,52,0],[222,17,222,34,0],[223,13,223,14,0],[224,9,224,10,0],[225,5,225,6,0]]);
    </script>
  </body>
</html>