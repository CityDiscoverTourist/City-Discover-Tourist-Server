<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\C#\CityDiscoverTourist\CityDiscoverTourist.Business\IServices\Services\FacebookService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Globalization;
using System.IdentityModel.Tokens.Jwt;
using System.Net.Http.Headers;
using System.Security.Claims;
using CityDiscoverTourist.Business.Data.RequestModel;
using CityDiscoverTourist.Business.Data.ResponseModel;
using CityDiscoverTourist.Data.Models;
using Microsoft.AspNetCore.Identity;
using Newtonsoft.Json;

namespace CityDiscoverTourist.Business.IServices.Services;

public class FacebookService: IFacebookService
{
    private readonly IAuthService _authService;
    private readonly UserManager&lt;ApplicationUser&gt; _userManager;

    private readonly HttpClient _httpClient;
    private const string FacebookUri = &quot;https://graph.facebook.com/v2.8/&quot;;

    public FacebookService(UserManager&lt;ApplicationUser&gt; userManager, IAuthService authService)
    {
        _userManager = userManager;
        _authService = authService;
        _httpClient = new HttpClient
        {
            BaseAddress = new Uri(FacebookUri)
        };
        _httpClient.DefaultRequestHeaders
            .Accept
            .Add(new MediaTypeWithQualityHeaderValue(&quot;application/json&quot;));
    }

    public async Task&lt;FacebookResponseModel&gt; GetUserFromFacebookAsync(string facebookToken)
    {
        var result = await GetAsync&lt;dynamic&gt;(facebookToken, &quot;me&quot;, &quot;scope=public_profile&amp;fields=first_name,last_name,email,id,picture.width(100).height(100)&quot;);
        if (result == null)
        {
            throw new KeyNotFoundException(&quot;Invalid facebook token&quot;);
        }

        var account = new FacebookResponseModel()
        {
            FullName = result.first_name + &quot; &quot; + result.last_name,
            ImagePath = result.picture.data.url,
            Email = result.email,
            FacebookId = result.id
        };

        return account;
    }

    public async Task&lt;T&gt; GetAsync&lt;T&gt;(string accessToken, string endpoint, string? args = null)
    {
        var response = await _httpClient.GetAsync($&quot;{endpoint}?access_token={accessToken}&amp;{args}&quot;);
        if (!response.IsSuccessStatusCode)
            return default(T)!;

        var result = await response.Content.ReadAsStringAsync();

        return JsonConvert.DeserializeObject&lt;T&gt;(result)!;
    }

    public async Task&lt;LoginResponseModel&gt; LoginFacebookAsync(string token)
    {
        if (string.IsNullOrEmpty(token))
        {
            throw new KeyNotFoundException(&quot;Token is null&quot;);
        }

        var facebookUser = await GetUserFromFacebookAsync(token);
        var userDb = await _userManager.FindByEmailAsync(facebookUser.Email);

        if (await CreateUserIfNotExits(userDb, facebookUser)) return null!;
        var authClaims = new List&lt;Claim&gt;
        {
            new (ClaimTypes.Name, facebookUser.FullName!),
            new (JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString()),
            new (ClaimTypes.Email, facebookUser.Email!),
            new (ClaimTypes.Expiration, DateTime.Now.AddHours(1).ToString(CultureInfo.CurrentCulture)),
        };

        var accessToken = _authService.GetJwtToken(authClaims);
        return new LoginResponseModel
        {
            IdProvider = facebookUser.FacebookId,
            Email = facebookUser.Email,
            FullName = facebookUser.FullName,
            ImagePath = facebookUser.ImagePath,
            JwtToken = new JwtSecurityTokenHandler().WriteToken(accessToken),
            RefreshToken = _authService.GenerateRefreshToken(),
            RefreshTokenExpiryTime = DateTime.Now.AddHours(1),
        };
    }

    private async Task&lt;bool&gt; CreateUserIfNotExits(ApplicationUser user, FacebookResponseModel facebookUser)
    {
        // ReSharper disable once ConditionIsAlwaysTrueOrFalse
        if (user != null) return false;
        user = new ApplicationUser()
        {
            UserName = facebookUser.Email,
            Email = facebookUser.Email,
            SecurityStamp = Guid.NewGuid().ToString(),
            EmailConfirmed = true,
            NormalizedEmail = facebookUser.Email!.ToUpper(new CultureInfo(&quot;en-US&quot;, false)),
            NormalizedUserName = facebookUser.FullName!.ToUpper(new CultureInfo(&quot;en-US&quot;, false)),
            PhoneNumberConfirmed = false,
        };
        var loginInfo = new ExternalLoginInfo(new ClaimsPrincipal(), &quot;Facebook&quot;, facebookUser.FacebookId, &quot;Facebook&quot;);
        var result = await _userManager.CreateAsync(user);
        await _userManager.AddLoginAsync(user, loginInfo);

        return !result.Succeeded;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,5,21,95,0],[22,5,22,6,0],[23,9,23,36,0],[24,9,24,36,0],[25,9,28,11,0],[29,9,31,75,0],[32,5,32,6,0],[35,5,35,6,0],[36,9,36,159,0],[37,9,37,28,0],[38,9,38,10,0],[39,13,39,70,0],[42,9,48,11,0],[50,9,50,24,0],[51,5,51,6,0],[54,5,54,6,0],[55,9,55,100,0],[56,9,56,43,0],[57,13,57,32,0],[59,9,59,65,0],[61,9,61,58,0],[62,5,62,6,0],[65,5,65,6,0],[66,9,66,41,0],[67,9,67,10,0],[68,13,68,61,0],[71,9,71,66,0],[72,9,72,78,0],[74,9,74,62,0],[74,63,74,76,0],[75,9,81,11,0],[83,9,83,64,0],[84,9,93,11,0],[94,5,94,6,0],[97,5,97,6,0],[99,9,99,26,0],[99,27,99,40,0],[100,9,109,11,0],[110,9,110,119,0],[111,9,111,59,0],[112,9,112,59,0],[114,9,114,34,0],[115,5,115,6,0]]);
    </script>
  </body>
</html>