<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\C#\CityDiscoverTourist\CityDiscoverTourist.Business\IServices\Services\AuthService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Globalization;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Security.Cryptography;
using System.Text;
using CityDiscoverTourist.Business.Data;
using CityDiscoverTourist.Business.Data.RequestModel;
using CityDiscoverTourist.Data.Models;
using FirebaseAdmin.Auth;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.Configuration;
using Microsoft.IdentityModel.Tokens;

namespace CityDiscoverTourist.Business.IServices.Services;

public class AuthService: IAuthService
{
    private readonly UserManager&lt;ApplicationUser&gt; _userManager;
    private static  IConfiguration? _configuration;


    public AuthService(UserManager&lt;ApplicationUser&gt; userManager, IConfiguration? configuration)
    {
        _userManager = userManager;
        _configuration = configuration;
    }

    public async Task&lt;LoginResponseModel&gt; LoginFirebase(LoginFirebaseModel model)
    {
        var userViewModel = await VerifyFirebaseToken(model.TokenId);
        var user = await _userManager.FindByNameAsync(userViewModel.Email);

        if (await CreateUserIfNotExits(user, userViewModel)) return null!;

        //if (user is {LockoutEnabled: false }) throw new ResponseModelException(ResponseCode.Forbidden, &quot;User is locked&quot;);
        //if (!user.LockoutEnabled) throw new ResponseModelException(ResponseCode.Forbidden, &quot;User is locked&quot;);
        var authClaims = new List&lt;Claim&gt;
        {
            new (ClaimTypes.Name, userViewModel.Email ?? string.Empty),
            new (JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString()),
            new (ClaimTypes.Email, userViewModel.Email ?? string.Empty),
            new (ClaimTypes.Expiration, DateTime.Now.AddHours(1).ToString(CultureInfo.CurrentCulture)),
        };

        var accessToken = GetJwtToken(authClaims);

        userViewModel.JwtToken = new JwtSecurityTokenHandler().WriteToken(accessToken);
        userViewModel.RefreshToken = GenerateRefreshToken();
        userViewModel.RefreshTokenExpiryTime = DateTime.Now.AddSeconds(7);
        return userViewModel;
    }

    private async Task&lt;bool&gt; CreateUserIfNotExits(ApplicationUser user, LoginResponseModel userViewModel)
    {
        if (user != null) return false;
        user = new ApplicationUser()
        {
            UserName = userViewModel.Email,
            Email = userViewModel.Email,
            SecurityStamp = Guid.NewGuid().ToString(),
            EmailConfirmed = true,
            NormalizedEmail = userViewModel.Email?.ToUpper(),
            NormalizedUserName = userViewModel.FullName?.ToUpper(),
            PhoneNumberConfirmed = false,
        };
        var loginInfo = new ExternalLoginInfo(new ClaimsPrincipal(), &quot;Firebase-Email&quot;, userViewModel.IdProvider, userViewModel.Email);
        var result = await _userManager.CreateAsync(user);
        await _userManager.AddLoginAsync(user, loginInfo);
        return !result.Succeeded;
    }

    public JwtSecurityToken GetJwtToken(IEnumerable&lt;Claim&gt; claims)
    {
        var secretKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_configuration![&quot;JWT:Secret&quot;]));
        var signingCredentials = new SigningCredentials(secretKey, SecurityAlgorithms.HmacSha256);

        var token = new JwtSecurityToken(
            _configuration[&quot;JWT:ValidIssuer&quot;],
            _configuration[&quot;JWT:ValidAudience&quot;],
            claims,
            expires: DateTime.Now.AddHours(1),
            signingCredentials: signingCredentials
        );

        return token;
    }

    public string GenerateRefreshToken()
    {
        var randomNumber = new byte[32];
        using var rng = RandomNumberGenerator.Create();
        rng.GetBytes(randomNumber);
        return Convert.ToBase64String(randomNumber);
    }

    public Task&lt;bool&gt; VerifyPhoneNumberByDigitCode(string username, int code)
    {
        throw new NotImplementedException();
    }

    private static async Task&lt;LoginResponseModel&gt; VerifyFirebaseToken(string? token)
    {
        var decodedToken = await FirebaseAuth.DefaultInstance.VerifyIdTokenAsync(token);

        var uid = decodedToken.Uid;
        var user = await FirebaseAuth.DefaultInstance.GetUserAsync(uid);
        // Query account table in DB

        var loginViewModel = new LoginResponseModel
        {
            IdProvider = uid,
            Email = user.Email,
            FullName = user.DisplayName,
            ImagePath = user.PhotoUrl
        };
        return loginViewModel;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[22,5,22,96,0],[23,5,23,6,0],[24,9,24,36,0],[25,9,25,40,0],[26,5,26,6,0],[29,5,29,6,0],[30,9,30,70,0],[31,9,31,76,0],[33,9,33,61,0],[33,62,33,75,0],[37,9,43,11,0],[45,9,45,51,0],[47,9,47,88,0],[48,9,48,61,0],[49,9,49,75,0],[50,9,50,30,0],[51,5,51,6,0],[54,5,54,6,0],[55,9,55,26,0],[55,27,55,40,0],[56,9,65,11,0],[66,9,66,135,0],[67,9,67,59,0],[68,9,68,59,0],[69,9,69,34,0],[70,5,70,6,0],[73,5,73,6,0],[74,9,74,105,0],[75,9,75,99,0],[77,9,83,11,0],[85,9,85,22,0],[86,5,86,6,0],[89,5,89,6,0],[90,9,90,41,0],[91,9,91,56,0],[92,9,92,36,0],[93,9,93,53,0],[94,5,94,6,0],[97,5,97,6,0],[98,9,98,45,0],[102,5,102,6,0],[103,9,103,89,0],[105,9,105,36,0],[106,9,106,73,0],[109,9,115,11,0],[116,9,116,31,0],[117,5,117,6,0]]);
    </script>
  </body>
</html>